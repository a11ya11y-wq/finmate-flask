{% extends 'base.html' %}

{% block title %}
    Dashboard
{% endblock %}

{% block body %}
    {% include '_flash_messages.html' %}
    {% set currency_symbol = '$' if current_user.currency == 'USD' else '‚Ç¨' if current_user.currency == 'EUR' else '‚Ç¥' %}
<div class="container-fluid">
  <div class="row">

    <!-- Sidebar: Add Transaction -->
    <div class="col-md-3 col-lg-2 bg-light border-end vh-100 p-4">
      <h5 class="mb-3">Add Transaction</h5>

      <form method="POST" action="{{ url_for('transaction.add_transaction') }}">
        <!-- ... (title, type, amount, category) ... -->
        <div class="mb-3">
          <label for="title" class="form-label">Title</label>
          <input type="text" class="form-control" id="title" name="title" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Type</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="transaction_type" id="expense" value="expense" checked>
            <label class="form-check-label" for="expense">Expense</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="transaction_type" id="income" value="income">
            <label class="form-check-label" for="income">Income</label>
          </div>
        </div>

        <div class="mb-3">
          <label for="amount" class="form-label">Amount</label>
          <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
        </div>

        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <label for="category" class="form-label mb-0">Category</label>
          </div>

          <select class="form-select" id="category" name="category_id" required>
            <option selected disabled value="">Choose...</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
          </select>

          <small class="form-text text-muted text-nowrap" style="font-size: 0.8em;">
            Manage in <a href="{{ url_for('profile.profile') }}">Profile</a>.
          </small>
        </div>


        <!-- === –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨ === -->
        <div class="mb-3">
          <label for="created_at" class="form-label">Date</label>
          <!-- 1. –£–±—Ä–∞–ª–∏ 'required'
               2. –î–æ–±–∞–≤–∏–ª–∏ 'value=""' (–¥–ª—è Firefox)
               3. –î–æ–±–∞–≤–∏–ª–∏ 'placeholder' -->
          <input type="date" class="form-control" id="created_at" name="created_at"
                 value=""
                 placeholder="Leave blank for today">
          <div class="form-text">Leave blank to use today's date.</div>
        </div>
        <!-- === –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø === -->


        <div class="mb-3">
          <label for="note" class="form-label">Note (optional)</label>
          <textarea class="form-control" id="note" name="note" rows="2"></textarea>
        </div>

        <button type="submit" class="btn btn-primary w-100">Add Transaction</button>
      </form>
    </div>

    <!-- Main Dashboard -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <!-- ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –¥–∞—à–±–æ—Ä–¥–∞) ... -->
<!-- ... [—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∞—à–±–æ—Ä–¥–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π] ... -->
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Dashboard</h1>

        <form method="GET" action="{{ url_for('core.dashboard') }}" class="d-flex justify-content-end">
          <select name="period" class="form-select w-auto" onchange="this.form.submit()">
            <option value="all" {% if period=='all' %}selected{% endif %}>All time</option>
            <option value="week" {% if period=='week' %}selected{% endif %}>Last 7 days</option>
            <option value="month" {% if period=='month' %}selected{% endif %}>Last 30 days</option>
          </select>
        </form>
      </div>

      <div class="row">
        <div class="col-md-4">
            <div class="card text-white bg-success-subtle border-success mb-3" style="--bs-bg-opacity: .7;">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-shrink-0 me-3">
                        <i class="bi bi-arrow-up-circle-fill fs-1 text-success"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="text-success text-uppercase small">Total Income</div>
                        <h3 class="card-title text-success mb-0">{{ currency_symbol }}{{ '%.2f'|format(total_income) }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-danger-subtle border-danger mb-3" style="--bs-bg-opacity: .7;">
                 <div class="card-body d-flex align-items-center">
                    <div class="flex-shrink-0 me-3">
                        <i class="bi bi-arrow-down-circle-fill fs-1 text-danger"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="text-danger text-uppercase small">Total Expense</div>
                        <h3 class="card-title text-danger mb-0">{{ currency_symbol }}{{ '%.2f'|format(total_expense) }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-dark bg-primary-subtle border-primary mb-3" style="--bs-bg-opacity: .7;">
                 <div class="card-body d-flex align-items-center">
                    <div class="flex-shrink-0 me-3">
                         <i class="bi bi-wallet2 fs-1 text-primary"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="text-primary text-uppercase small">Current Balance</div>
                        <h3 class="card-title text-primary mb-0">{{ currency_symbol }}{{ '%.2f'|format(balance) }}</h3>
                    </div>
                </div>
            </div>
        </div>
      </div>

    <div class="row mt-4">
        <div class="col-12">
          <h4 class="mb-3">Balance Dynamics</h4>
          <canvas id="balanceLineChart" width="900" height="300"></canvas>
        </div>
      </div>

      <!-- Charts and Transactions -->
      <div class="row mt-4">
        <div class="col-md-5">
          <h4 class="mb-3">Expenses by Category</h4>
          <canvas id="categoryDonutChart"></canvas>
        </div>

        <div class="col-md-7">
          <h4 class="mb-3">Recent Transactions</h4>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Title</th>
                  <th>Amount</th>
                  <th>Category</th>
                  <th>Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for t in transactions %}
                  <tr>
                    <td>{{ loop.index }}</td>
                    <td>
                      {{ t.title }}
                      {% if t.note %}
                        <small class="d-block text-muted">{{ t.note }}</small>
                      {% endif %}
                    </td>

                    {% if t.transaction_type == 'income' %}
                      <td class="text-success fw-bold">+{{ currency_symbol }}{{ '%.2f'|format(t.amount) }}</td>
                    {% else %}
                      <td class="text-danger">-{{ currency_symbol }}{{ '%.2f'|format(t.amount) }}</td>
                    {% endif %}

                    <td>{{ t.category.name }}</td>
                    <td>{{ t.created_at.strftime('%Y-%m-%d') }}</td>

                    <td>
                      <button type="button"
                              class="btn btn-primary btn-sm"
                              data-bs-toggle="modal"
                              data-bs-target="#editTransactionModal"
                              data-bs-transaction-id="{{ t.id }}"
                              data-bs-title="{{ t.title }}"
                              data-bs-amount="{{ t.amount }}"
                              data-bs-type="{{ t.transaction_type }}"
                              data-bs-category-id="{{ t.category_id }}"
                              data-bs-note="{{ t.note | default('', true) }}"
                              data-bs-date="{{ t.created_at.strftime('%Y-%m-%d') }}">
                        Edit
                      </button>

                      <form method="POST" action="{{ url_for('transaction.delete_transaction', id=t.id) }}" style="display:inline;">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure?');">
                          Delete
                        </button>
                      </form>
                    </td>
                  </tr>
                {% else %}
                  <tr><td colspan="6" class="text-center text-muted">No transactions yet</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Chart.js -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
        const ctx = document.getElementById('categoryDonutChart');
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: {{ category_labels|tojson }},
            datasets: [{
              label: 'Expenses',
              data: {{ category_amounts|tojson }},
              backgroundColor: [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)'
              ],
              borderColor: '#fff',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' }
            }
          }
        });
      </script>
    </main>
  </div>
</div>

<!-- Edit Transaction Modal -->
<div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" id="editTransactionForm">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Edit Transaction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="edit_title" class="form-label">Title</label>
            <input type="text" class="form-control" id="edit_title" name="title" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Type</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="transaction_type" id="edit_expense" value="expense">
              <label class="form-check-label" for="edit_expense">Expense</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="transaction_type" id="edit_income" value="income">
              <label class="form-check-label" for="edit_income">Income</label>
            </div>
          </div>

          <div class="mb-3">
            <label for="edit_amount" class="form-label">Amount</label>
            <input type="number" step="0.01" class="form-control" id="edit_amount" name="amount" required>
          </div>

          <div class="mb-3">
            <label for="edit_category" class="form-label">Category</label>
            <select class="form-select" id="edit_category" name="category_id" required>
              <option disabled value="">Choose...</option>
              {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label for="edit_date" class="form-label">Date</label>
            <input type="date" class="form-control" id="edit_date" name="created_at" required>
          </div>

          <div class="mb-3">
            <label for="edit_note" class="form-label">Note (optional)</label>
            <textarea class="form-control" id="edit_note" name="note" rows="2"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const editModal = document.getElementById('editTransactionModal');
  editModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;

    const transactionId = button.getAttribute('data-bs-transaction-id');
    const title = button.getAttribute('data-bs-title');
    const amount = button.getAttribute('data-bs-amount');
    const type = button.getAttribute('data-bs-type');
    const categoryId = button.getAttribute('data-bs-category-id');
    const date = button.getAttribute('data-bs-date');
    const note = button.getAttribute('data-bs-note');

    const modalForm = editModal.querySelector('#editTransactionForm');
    modalForm.action = `/edit/{{ currency_symbol }}${transactionId}`; // üëà –ò–°–ü–†–ê–í–¨ –≠–¢–£ –û–®–ò–ë–ö–£
    modalForm.querySelector('#edit_title').value = title;
    modalForm.querySelector('#edit_amount').value = amount;
    modalForm.querySelector('#edit_category').value = categoryId;
    modalForm.querySelector('#edit_date').value = date;
    modalForm.querySelector('#edit_note').value = note;

    if (type === 'income') {
      modalForm.querySelector('#edit_income').checked = true;
    } else {
      modalForm.querySelector('#edit_expense').checked = true;
    }
  });
</script>
    <script>
        // –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ Chart.js –≤–∂–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –≤–∏—â–µ
        const ctxLine = document.getElementById('balanceLineChart');
        if (ctxLine) { // –î–æ–¥–∞—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É, —á–∏ –µ–ª–µ–º–µ–Ω—Ç —ñ—Å–Ω—É—î
          new Chart(ctxLine, {
              type: 'line',
              data: {
                  labels: {{ balance_labels|tojson }}, // üëà –¢–æ–±—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç–∏ —Ü—é –∑–º—ñ–Ω–Ω—É –∑ Python
                  datasets: [{
                      label: 'Balance',
                      fill: false, // –ó–∞—Ñ–∞—Ä–±–æ–≤—É—î–º–æ –æ–±–ª–∞—Å—Ç—å –ø—ñ–¥ –ª—ñ–Ω—ñ—î—é
                      backgroundColor: 'rgba(13, 110, 253, 0.2)', // –ù–∞–ø—ñ–≤–ø—Ä–æ–∑–æ—Ä–∏–π —Å–∏–Ω—ñ–π
                      borderColor: 'rgba(13, 110, 253, 1)', // –ù–∞—Å–∏—á–µ–Ω–∏–π —Å–∏–Ω—ñ–π
                      data: {{ balance_data|tojson }}, // üëà –¢–æ–±—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç–∏ —Ü—é –∑–º—ñ–Ω–Ω—É –∑ Python
                      tension: 0.2 // –†–æ–±–∏—Ç—å –ª—ñ–Ω—ñ—é —Ç—Ä–æ—Ö–∏ –ø–ª–∞–≤–Ω—ñ—à–æ—é
                  }]
              },
              options: {
                  responsive: true,
                  plugins: { legend: { display: false } }, // –õ–µ–≥–µ–Ω–¥—É –º–æ–∂–Ω–∞ –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏
                  scales: {
                      x: { display: true },
                      // –ë–∞–ª–∞–Ω—Å –º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥'—î–º–Ω–∏–º, —Ç–æ–º—É –Ω–µ –ø–æ—á–∏–Ω–∞—î–º–æ –∑ –Ω—É–ª—è
                      y: { display: true, beginAtZero: false }
                  }
              }
          });
        } else {
            console.error("Canvas element for balance chart not found!");
        }
      </script>
{% endblock %}

